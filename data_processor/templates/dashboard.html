<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPLUG-ANALYTICA - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --navy-blue: #41416f;
            --gold: #FFD700;
            --white: #FFFFFF;
        }
        .glass-header {
            background: rgba(99, 99, 185, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .metric-card {
            background: var(--white);
            border: 1px solid var(--navy-blue);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 128, 0.1);
        }
        .chart-card {
            background: var(--white);
            border: 1px solid var(--navy-blue);
        }
        .trend-up {
            color: #10B981;
        }
        .trend-down {
            color: #EF4444;
        }
    </style>
</head>
<body class="bg-white">
    <!-- Header -->
    <header class="glass-header shadow fixed w-full z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="{{ url_for('static', filename='logo/logo.png') }}" alt="Logo" class="w-auto mr-3 p-2 bg-white rounded" style="height: 38px; min-width: 38px;">
                    <h1 class="text-2xl font-bold text-white">XPLUG-ANALYTICA</h1>
                </div>
                <nav class="flex items-center space-x-4">
                    <a href="/dashboard" class="nav-link active">Dashboard</a>
                    <a href="/clients" class="nav-link">Clients</a>
                    <a href="/products" class="nav-link">Products</a>
                    <a href="/loans" class="nav-link">Loans</a>
                    <a href="/reports" class="nav-link">Reports</a>
                    <a href="/data-quality" class="nav-link">Data Quality</a>
                    <button onclick="logout()" class="nav-link">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="pt-20 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Overview Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <!-- Account Statistics -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Accounts</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Active</span>
                            <span class="font-bold text-green-600">{{ revenue_metrics.active_clients }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Inactive</span>
                            <span class="font-bold text-yellow-600">{{ revenue_metrics.inactive_clients }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Closed</span>
                            <span class="font-bold text-red-600">{{ revenue_metrics.closed_clients }}</span>
                        </div>
                        <div class="pt-2 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium">Total</span>
                                <span class="font-bold" style="color: var(--navy-blue);">{{ revenue_metrics.contributing_clients }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Revenue -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Total Revenue</h3>
                    <p class="text-3xl font-bold" style="color: var(--navy-blue);">${{ "{:,.2f}".format(revenue_metrics.total_revenue) }}</p>
                    <div class="mt-2 space-y-1">
                        <span class="text-sm text-gray-600">From {{ revenue_metrics.contributing_clients }} clients</span>
                        <!-- Currency Breakdown -->
                        <div class="pt-2 border-t border-gray-200 mt-2">
                            <h4 class="text-sm font-medium text-gray-700">Currency Breakdown</h4>
                            <div class="flex justify-between items-center text-sm">
                                <span>USD</span>
                                <span class="font-medium">${{ "{:,.2f}".format(revenue_metrics.usd_revenue or 0) }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>ZWL</span>
                                <span class="font-medium">${{ "{:,.2f}".format(revenue_metrics.zwl_revenue or 0) }}</span>
                            </div>
                        </div>
                        <!-- Contributors Breakdown -->
                        <div class="pt-2 border-t border-gray-200 mt-2">
                            <h4 class="text-sm font-medium text-gray-700">Revenue Sources</h4>
                            <div class="flex justify-between items-center text-sm">
                                <span>Loans</span>
                                <span class="font-medium">{{ "{:.1f}%".format(revenue_metrics.loan_contribution or 100.0) }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>ATM</span>
                                <span class="font-medium">{{ "{:.1f}%".format(revenue_metrics.atm_percentage or 33.33) }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>Internet</span>
                                <span class="font-medium">{{ "{:.1f}%".format(revenue_metrics.internet_percentage or 50.0) }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>SMS</span>
                                <span class="font-medium">{{ "{:.1f}%".format(revenue_metrics.sms_percentage or 16.67) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Branches -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Branches</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Total Branches</span>
                            <span class="font-bold" style="color: var(--navy-blue);">{{ revenue_metrics.total_branches }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Active</span>
                            <span class="font-bold text-green-600">{{ revenue_metrics.active_branches }}</span>
                        </div>
                    </div>
                </div>

                <!-- Channels -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Channels</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ATM</span>
                            <span class="font-bold text-blue-600">${{ "{:,.2f}".format(revenue_metrics.atm_revenue) }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Internet</span>
                            <span class="font-bold text-green-600">${{ "{:,.2f}".format(revenue_metrics.internet_revenue) }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">SMS</span>
                            <span class="font-bold text-yellow-600">${{ "{:,.2f}".format(revenue_metrics.sms_revenue) }}</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Primary Metrics Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- CLV Metrics -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Average CLV</h3>
                    <p class="text-3xl font-bold" style="color: var(--navy-blue);">${{ "{:,.2f}".format(metrics.avg_clv if not metrics.avg_clv is mapping else metrics.avg_clv.value) }}</p>
                    <p class="text-sm mt-1 text-gray-600">Per customer value</p>
                    <div class="mt-2 flex items-center">
                        <span class="{{ 'trend-up' if metrics.clv_trend == 'Upward' else 'trend-down' }} text-sm font-medium">
                            {{ metrics.clv_trend }} Trend
                        </span>
                    </div>
                </div>

                <!-- CAC and Ratio -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">CLV:CAC Ratio</h3>
                    <p class="text-3xl font-bold" style="color: var(--navy-blue);">{{ "{:.1f}".format(metrics.clv_cac_ratio) }}x</p>
                    <p class="text-sm mt-1 text-gray-600">Return on acquisition</p>
                    <div class="mt-2">
                        <span class="text-sm text-gray-600">{{ metrics.cac_breakdown }}</span>
                    </div>
                </div>

                <!-- Churn Metrics -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Churn Rate</h3>
                    <p class="text-3xl font-bold" style="color: var(--navy-blue);">{{ "{:.1f}%".format(metrics.churn_rate) }}</p>
                    <p class="text-sm mt-1 text-gray-600">Current period</p>
                    <div class="mt-2">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full 
                            {{ 'bg-green-100 text-green-800' if metrics.churn_prediction == 'Low Risk' else 
                               'bg-yellow-100 text-yellow-800' if metrics.churn_prediction == 'Medium Risk' else 
                               'bg-red-100 text-red-800' }}">
                            {{ metrics.churn_prediction }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Secondary Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Revenue Metrics -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Revenue per Customer</h3>
                    <p class="text-3xl font-bold" style="color: var(--navy-blue);">${{ "{:,.2f}".format(metrics.revenue_per_customer) }}</p>
                    <p class="text-sm mt-1 text-gray-600">Average monthly</p>
                    <div class="mt-2">
                        <span class="text-sm text-gray-600">{{ "{:.1f}%".format(metrics.predicted_growth) }}% Growth Expected</span>
                    </div>
                </div>

                <!-- Retention Metrics -->
                <div class="metric-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--navy-blue);">Retention Rate</h3>
                    <p class="text-3xl font-bold" style="color: var(--navy-blue);">{{ "{:.1f}%".format(metrics.retention_rate) }}</p>
                    <p class="text-sm mt-1 text-gray-600">Customer loyalty</p>
                    <div class="mt-2">
                        <span class="text-sm text-gray-600">Based on 12-month data</span>
                    </div>
                </div>
            </div>

            <!-- Churn Risk Factors -->
            <div class="chart-card rounded-lg p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4" style="color: var(--navy-blue);">Churn Risk Factors</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="relative h-64">
                        <canvas id="churnFactorsChart"></canvas>
                    </div>
                    <div class="space-y-4">
                        <div class="metric-card p-4 rounded">
                            <h4 class="font-semibold text-sm" style="color: var(--navy-blue);">Factor Details</h4>
                            <ul class="mt-2 space-y-2 text-sm" id="churnFactorDetails">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Customer Segments -->
                <div class="chart-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--navy-blue);">Customer Segments</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative h-64">
                            <canvas id="customerSegmentsChart"></canvas>
                        </div>
                        <div class="space-y-2">
                            <h4 class="font-semibold text-sm" style="color: var(--navy-blue);">Segment Profitability</h4>
                            <ul class="space-y-3" id="segmentDetails">
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Revenue Trends -->
                <div class="chart-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--navy-blue);">Revenue Trends</h3>
                    <div class="relative h-64">
                        <canvas id="revenueTrendsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- CAC Analysis -->
            <div class="chart-card rounded-lg p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4" style="color: var(--navy-blue);">Customer Acquisition Cost Breakdown</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="relative h-64">
                        <canvas id="cacBreakdownChart"></canvas>
                    </div>
                    <div class="space-y-4">
                        <div class="metric-card p-4 rounded">
                            <h4 class="font-semibold text-sm" style="color: var(--navy-blue);">Marketing Channels</h4>
                            <ul class="mt-2 space-y-2 text-sm">
                                <li class="flex justify-between">
                                    <span>Digital Advertising</span>
                                    <span>${{ "{:,.2f}".format(metrics.cac_digital_ads) }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Content Marketing</span>
                                    <span>${{ "{:,.2f}".format(metrics.cac_content) }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Social Media</span>
                                    <span>${{ "{:,.2f}".format(metrics.cac_social) }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="metric-card p-4 rounded">
                            <h4 class="font-semibold text-sm" style="color: var(--navy-blue);">Sales & Operations</h4>
                            <ul class="mt-2 space-y-2 text-sm">
                                <li class="flex justify-between">
                                    <span>Sales Team</span>
                                    <span>${{ "{:,.2f}".format(metrics.cac_sales_team) }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Customer Support</span>
                                    <span>${{ "{:,.2f}".format(metrics.cac_support) }}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Tools & Software</span>
                                    <span>${{ "{:,.2f}".format(metrics.cac_tools) }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Analysis -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CLV by Channel -->
                <div class="chart-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--navy-blue);">CLV by Channel</h3>
                    <div class="relative h-64">
                        <canvas id="channelClvChart"></canvas>
                    </div>
                </div>

                <!-- Retention Analysis -->
                <div class="chart-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--navy-blue);">Retention Analysis</h3>
                    <div class="relative h-64">
                        <canvas id="retentionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function logout() {
            window.location.href = '/logout';
        }

        const chartConfig = {
            colors: {
                primary: '#000080',
                secondary: '#FFD700',
                tertiary: 'rgba(0, 0, 128, 0.6)',
                quaternary: 'rgba(255, 215, 0, 0.6)'
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Parse JSON data safely for charts
            const data = JSON.parse('{{ chart_data_json|safe }}');
            
            if (data.cac_breakdown) {
                new Chart(document.getElementById('cacBreakdownChart').getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: data.cac_breakdown.labels,
                        datasets: [{
                            data: data.cac_breakdown.data,
                            backgroundColor: [
                                chartConfig.colors.primary,
                                chartConfig.colors.secondary,
                                chartConfig.colors.tertiary,
                                chartConfig.colors.quaternary,
                                'rgba(0, 0, 128, 0.4)',
                                'rgba(255, 215, 0, 0.4)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
            
            // Customer Segments Chart with Profitability Highlights
            new Chart(document.getElementById('customerSegmentsChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: data.segments.labels,
                    datasets: [{
                        data: data.segments.data,
                        backgroundColor: [
                            'rgba(0, 128, 0, 0.8)',  // Dark green for most profitable
                            'rgba(144, 238, 144, 0.8)',  // Light green for profitable
                            'rgba(255, 215, 0, 0.8)',  // Gold for moderate
                            'rgba(255, 99, 71, 0.8)'   // Tomato for trial/new
                        ],
                        borderColor: [
                            'rgb(0, 128, 0)',
                            'rgb(144, 238, 144)',
                            'rgb(255, 215, 0)',
                            'rgb(255, 99, 71)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        `Revenue: $${data.segments.profitability[index].toLocaleString()}`,
                                        `Growth: ${data.segments.growth_rate[index]}%`,
                                        data.segments.descriptions[index]
                                    ];
                                }
                            }
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // Populate segment details
            const segmentDetails = document.getElementById('segmentDetails');
            data.segments.labels.forEach((label, index) => {
                const li = document.createElement('li');
                li.className = 'p-2 rounded border border-gray-200';
                const profitClass = index === 0 ? 'text-green-800' : 
                                  index === 1 ? 'text-green-600' :
                                  index === 2 ? 'text-yellow-600' : 'text-red-500';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium ${profitClass}">${label}</span>
                        <span class="font-bold">$${data.segments.profitability[index].toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        <span class="inline-block mr-4">Growth: ${data.segments.growth_rate[index]}%</span>
                        <span>Share: ${data.segments.data[index]}%</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${data.segments.descriptions[index]}</div>
                `;
                segmentDetails.appendChild(li);
            });

            new Chart(document.getElementById('revenueTrendsChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.revenue.labels,
                    datasets: [{
                        label: 'Revenue',
                        data: data.revenue.data,
                        borderColor: chartConfig.colors.primary,
                        backgroundColor: chartConfig.colors.tertiary,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            new Chart(document.getElementById('channelClvChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.channels.labels,
                    datasets: [{
                        label: 'CLV by Channel',
                        data: data.channels.data,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Blue for Direct
                            'rgba(16, 185, 129, 0.8)',   // Green for Referral
                            'rgba(245, 158, 11, 0.8)',   // Orange for Social
                            'rgba(139, 92, 246, 0.8)'    // Purple for Email
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `CLV: $${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Customer Lifetime Value ($)'
                            }
                        }
                    }
                }
            });

            new Chart(document.getElementById('retentionChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.retention.labels,
                    datasets: [{
                        label: 'Retention Rate',
                        data: data.retention.data,
                        borderColor: chartConfig.colors.primary,
                        backgroundColor: chartConfig.colors.tertiary,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Churn Risk Factors Chart
            if (data.churn_factors) {
                new Chart(document.getElementById('churnFactorsChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.churn_factors.labels,
                        datasets: [{
                            label: 'Risk Level (%)',
                            data: data.churn_factors.data,
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.7)',   // Red for time-based
                                'rgba(16, 185, 129, 0.7)',  // Green for digital
                                'rgba(59, 130, 246, 0.7)',  // Blue for products
                                'rgba(245, 158, 11, 0.7)'   // Orange for status
                            ],
                            borderColor: [
                                'rgb(239, 68, 68)',
                                'rgb(16, 185, 129)',
                                'rgb(59, 130, 246)',
                                'rgb(245, 158, 11)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Risk Level (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        return data.churn_factors.descriptions[context.dataIndex];
                                    }
                                }
                            }
                        }
                    }
                });

                // Populate factor details
                const detailsList = document.getElementById('churnFactorDetails');
                data.churn_factors.labels.forEach((label, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex flex-col';
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${label}</span>
                            <span class="font-bold">${data.churn_factors.data[index].toFixed(1)}%</span>
                        </div>
                        <span class="text-xs text-gray-600">${data.churn_factors.descriptions[index]}</span>
                    `;
                    detailsList.appendChild(li);
                });
            }
        });
    </script>
</body>
</html>
