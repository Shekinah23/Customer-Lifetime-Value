<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPLUG-ANALYTICA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --navy-blue: #41416f;
            --gold: #FFD700;
            --white: #FFFFFF;
        }
        .glass-header {
            background: rgba(99, 99, 185, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .metric-card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            padding: 1.5rem;
        }
        .metric-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--navy-blue);
            line-height: 1.2;
            margin: 0.75rem 0;
        }
        .metric-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .metric-trend {
            display: inline-flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            margin-top: 0.5rem;
        }
        .trend-positive {
            background-color: #dcfce7;
            color: #15803d;
        }
        .trend-negative {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .trend-up {
            color: #10B981;
        }
        .trend-down {
            color: #EF4444;
        }
        .nav-link {
            color: var(--white);
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
        }
        .nav-link:hover {
            color: var(--gold);
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-link.active {
            color: var(--gold);
            background: rgba(255, 255, 255, 0.15);
        }
        .metric-value {
            position: relative;
            cursor: help;
        }
        .metric-value:hover::after {
            content: attr(title);
            position: absolute;
            left: 0;
            top: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 10;
        }
    </style>

</head>
<body class="bg-white">
    <!-- Header with Navigation -->
    <header class="glass-header shadow fixed w-full z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="{{ url_for('static', filename='logo/logo.png') }}" alt="Logo" class="w-auto mr-3 p-2 bg-white rounded" style="height: 38px; min-width: 38px;">
                    <h1 class="text-2xl font-bold text-white">XPLUG-ANALYTICA</h1>
                </div>
                <nav class="flex items-center space-x-4">
                    <a href="/clients" class="nav-link">Clients</a>
                    <a href="/products" class="nav-link">Products</a>
                    <a href="/loans" class="nav-link">Loans</a>
                    <a href="/reports" class="nav-link">Reports</a>
                    <a href="/data-quality" class="nav-link">Data Quality</a>
                    <button onclick="logout()" class="nav-link">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="pt-20 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Overview Statistics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                <!-- Account Statistics -->
                <div class="metric-card">
                    <div class="metric-label">Total Accounts</div>
                    <div class="metric-value">{{ metrics.total_clients }}</div>
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-4">
                            <div>
                                <span class="text-sm text-green-700">{{ metrics.active_clients }} Active</span>
                            </div>
                            <div>
                                <span class="text-sm text-yellow-700">{{ metrics.inactive_clients }} Inactive</span>
                            </div>
                        </div>
                        <div class="metric-trend {{ 'trend-positive' if metrics.total_clients_growth > 0 else 'trend-negative' }}">
                            {{ '↑' if metrics.total_clients_growth > 0 else '↓' }} {{ "{:.1f}".format(metrics.total_clients_growth_abs) }}%
                        </div>
                    </div>
                </div>

                <!-- Total Revenue -->
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value" title="{{ metrics.total_revenue.words }}">
                        ${{ "{:,.2f}".format(metrics.total_revenue.value) }}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">{{ metrics.total_clients }} clients</span>
                        <div class="metric-trend {{ 'trend-positive' if metrics.total_revenue_growth > 0 else 'trend-negative' }}">
                            {{ '↑' if metrics.total_revenue_growth > 0 else '↓' }} {{ "{:.1f}".format(metrics.total_revenue_growth_abs) }}%
                        </div>
                    </div>
                </div>

                <!-- Branches -->
                <div class="metric-card">
                    <div class="metric-label">Branches</div>
                    <div class="metric-value">{{ metrics.total_branches }}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-green-700">{{ metrics.active_branches }} Active</span>
                        <div class="metric-trend {{ 'trend-positive' if metrics.active_branches_growth > 0 else 'trend-negative' }}">
                            {{ '↑' if metrics.active_branches_growth > 0 else '↓' }} {{ "{:.1f}".format(metrics.active_branches_growth_abs) }}%
                        </div>
                    </div>
                </div>

                <!-- Channels -->
                <div class="metric-card">
                    <div class="metric-label">Channel Revenue</div>
                    <div class="metric-value" title="{{ metrics.atm_revenue.words }}">
                        ${{ "{:,.2f}".format(metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) }}
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-4">
                            <span class="text-sm text-blue-600">ATM {{ "{:.1f}".format((metrics.atm_revenue.value / (metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) * 100) if (metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) > 0 else 0) }}%</span>
                            <span class="text-sm text-green-600">Internet {{ "{:.1f}".format((metrics.internet_revenue.value / (metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) * 100) if (metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) > 0 else 0) }}%</span>
                            <span class="text-sm text-yellow-600">SMS {{ "{:.1f}".format((metrics.sms_revenue.value / (metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) * 100) if (metrics.atm_revenue.value + metrics.internet_revenue.value + metrics.sms_revenue.value) > 0 else 0) }}%</span>
                        </div>
                        <div class="metric-trend {{ 'trend-positive' if metrics.total_revenue_growth > 0 else 'trend-negative' }}">
                            {{ '↑' if metrics.total_revenue_growth > 0 else '↓' }} {{ "{:.1f}".format(metrics.total_revenue_growth_abs) }}%
                        </div>
                    </div>
                </div>

            </div>

            <!-- Primary Metrics Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- CLV Metrics -->
                <div class="metric-card">
                    <div class="metric-label">Average CLV</div>
                    <div class="metric-value" title="{{ metrics.avg_clv.words }}">
                        ${{ "{:,.2f}".format(metrics.avg_clv.value) }}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Per customer value</span>
                        <div class="metric-trend {{ 'trend-positive' if metrics.clv_trend == 'Upward' else 'trend-negative' }}">
                            {{ '↑' if metrics.clv_trend == 'Upward' else '↓' }} {{ metrics.predicted_growth }}%
                        </div>
                    </div>
                </div>

                <!-- CAC and Ratio -->
                <div class="metric-card">
                    <div class="metric-label">CLV:CAC Ratio</div>
                    <div class="metric-value">{{ "{:.1f}".format(metrics.clv_cac_ratio) }}x</div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Return on acquisition</span>
                        <div class="metric-trend trend-positive">
                            ↑ 10%
                        </div>
                    </div>
                </div>

                <!-- Churn Metrics -->
                <div class="metric-card">
                    <div class="metric-label">Churn Rate</div>
                    <div class="metric-value">{{ "{:.1f}%".format(metrics.churn_rate) }}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm {{ 'text-green-700' if metrics.churn_prediction == 'Low Risk' else 'text-yellow-700' if metrics.churn_prediction == 'Medium Risk' else 'text-red-700' }}">
                            {{ metrics.churn_prediction }}
                        </span>
                        <div class="metric-trend {{ 'trend-positive' if metrics.churn_improving else 'trend-negative' }}">
                            {{ '↓' if metrics.churn_improving else '↑' }} {{ "{:.1f}".format(metrics.churn_trend) }}%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Customer Segments -->
                <div class="metric-card">
                    <div class="metric-label">Customer Segments</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative h-64">
                            <canvas id="customerSegmentsChart"></canvas>
                        </div>
                        <div>
                            <div class="metric-label mb-2">Segment Profitability</div>
                            <ul class="space-y-3" id="segmentDetails">
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Revenue Trends -->
                <div class="metric-card">
                    <div class="metric-label">Revenue Trends</div>
                    <div class="relative h-64">
                        <canvas id="revenueTrendsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Churn Risk Factors -->
            <div class="metric-card mb-8">
                <div class="metric-label">Churn Risk Factors</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="relative h-64">
                        <canvas id="churnFactorsChart"></canvas>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="metric-label mb-2">Factor Details</div>
                            <ul class="mt-2 space-y-2 text-sm" id="churnFactorDetails">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function logout() {
            window.location.href = '/logout';
        }

        const chartConfig = {
            colors: {
                primary: '#41416f',
                secondary: '#64748b',
                tertiary: 'rgba(65, 65, 111, 0.1)',
                quaternary: '#94a3b8'
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const data = {{ chart_data_json|safe }};
            
            // Customer Segments Chart with Profitability Highlights
            new Chart(document.getElementById('customerSegmentsChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: data.segments.labels,
                    datasets: [{
                        data: data.segments.data,
                        backgroundColor: [
                            'rgba(0, 128, 0, 0.8)',  // Dark green for most profitable
                            'rgba(144, 238, 144, 0.8)',  // Light green for profitable
                            'rgba(255, 215, 0, 0.8)',  // Gold for moderate
                            'rgba(255, 99, 71, 0.8)'   // Tomato for trial/new
                        ],
                        borderColor: [
                            'rgb(0, 128, 0)',
                            'rgb(144, 238, 144)',
                            'rgb(255, 215, 0)',
                            'rgb(255, 99, 71)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        `Revenue: $${data.segments.profitability[index].toLocaleString()}`,
                                        `Growth: ${data.segments.growth_rate[index]}%`,
                                        data.segments.descriptions[index]
                                    ];
                                }
                            }
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // Populate segment details
            const segmentDetails = document.getElementById('segmentDetails');
            data.segments.labels.forEach((label, index) => {
                const li = document.createElement('li');
                li.className = 'p-2 rounded border border-gray-200';
                const profitClass = index === 0 ? 'text-green-800' : 
                                  index === 1 ? 'text-green-600' :
                                  index === 2 ? 'text-yellow-600' : 'text-red-500';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium ${profitClass}">${label}</span>
                        <span class="font-bold">$${data.segments.profitability[index].toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        <span class="inline-block mr-4">Growth: ${data.segments.growth_rate[index]}%</span>
                        <span>Share: ${data.segments.data[index]}%</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${data.segments.descriptions[index]}</div>
                `;
                segmentDetails.appendChild(li);
            });

            new Chart(document.getElementById('revenueTrendsChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.revenue.labels,
                    datasets: [{
                        label: 'Revenue',
                        data: data.revenue.data,
                        borderColor: chartConfig.colors.primary,
                        backgroundColor: chartConfig.colors.tertiary,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Churn Risk Factors Chart
            if (data.churn_factors) {
                new Chart(document.getElementById('churnFactorsChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.churn_factors.labels,
                        datasets: [{
                            label: 'Risk Level (%)',
                            data: data.churn_factors.data,
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.7)',   // Red for time-based
                                'rgba(16, 185, 129, 0.7)',  // Green for digital
                                'rgba(59, 130, 246, 0.7)',  // Blue for products
                                'rgba(245, 158, 11, 0.7)'   // Orange for status
                            ],
                            borderColor: [
                                'rgb(239, 68, 68)',
                                'rgb(16, 185, 129)',
                                'rgb(59, 130, 246)',
                                'rgb(245, 158, 11)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Risk Level (%)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        return data.churn_factors.descriptions[context.dataIndex];
                                    }
                                }
                            }
                        }
                    }
                });

                // Populate factor details
                const detailsList = document.getElementById('churnFactorDetails');
                data.churn_factors.labels.forEach((label, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex flex-col';
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${label}</span>
                            <span class="font-bold">${data.churn_factors.data[index].toFixed(1)}%</span>
                        </div>
                        <span class="text-xs text-gray-600">${data.churn_factors.descriptions[index]}</span>
                    `;
                    detailsList.appendChild(li);
                });
            }
        });
    </script>
</body>
</html>
